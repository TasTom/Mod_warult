using System.Collections.Generic;
using System.Linq;
using HarmonyLib;
using RimWorld;
using RimWorld.Planet;
using Verse;
using Verse.AI;
using Verse.AI.Group;

namespace Mod_warult
{
    /*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*\
    |  1.  Extension XML port√©e par chaque IncidentDef           |
    \*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
    public class BossSiteExtension : DefModExtension
    {
        public string sitePartDefName;   // ex : Expedition33_GobluSitePart
        public string bossDefName;       // ex : Expedition33_Goblu
        public string questId;           // ex : ActeI_VallonsFleuris
        public float  threatLevel = 1f;  // r√©serve pour Storyteller
    }

    /*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*\
    |  2.  Worker unique qui cr√©e r√©ellement le point d‚Äôint√©r√™t |
    \*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
    public class IncidentWorker_SpawnBossSite : IncidentWorker
    {
        protected override bool CanFireNowSub(IncidentParms parms) => true;

        protected override bool TryExecuteWorker(IncidentParms parms)
        {
            var ext = def.GetModExtension<BossSiteExtension>();
            if (ext == null)
            {
                Log.Error($"[Expedition33] BossSiteExtension manquante sur {def.defName}");
                return false;
            }

            /*--- 2-A  S√©lection d‚Äôune tuile ¬≠--------------------------------*/
            PlanetTile planetTile;
            if (!TileFinder.TryFindNewSiteTile(out planetTile, 8, 15, false, null))
            {
                Log.Warning("[Expedition33] Aucune tuile disponible pour le site boss");
                return false;
            }
            int tile = planetTile.tileId;

            /*--- 2-B  R√©cup√©ration du SitePartDef ¬≠---------------------------*/
            SitePartDef partDef = DefDatabase<SitePartDef>.GetNamedSilentFail(ext.sitePartDefName);
            if (partDef == null)
            {
                Log.Error($"[Expedition33] SitePartDef introuvable : {ext.sitePartDefName}");
                return false;
            }

            /*--- 2-C  Cr√©ation et enregistrement du site ¬≠-------------------*/
            Site site = SiteMaker.MakeSite(partDef, tile, parms.faction);
            site.SetFaction(parms.faction);
            Find.WorldObjects.Add(site);

            /*--- 2-D  Lettre d‚Äôinformation ¬≠---------------------------------*/
            Find.LetterStack.ReceiveLetter(
                GetLetterTitle(ext.questId),
                GetLetterText(ext.questId, ext.bossDefName),
                LetterDefOf.ThreatBig,
                site);

            Log.Message($"[Expedition33] Site boss ¬´ {ext.sitePartDefName} ¬ª cr√©√© (tuile {tile})");
            return true;
        }

        /*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Lettres ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
        private static string GetLetterTitle(string questId) => questId switch
        {
            "ActeI_VallonsFleuris"   => "üå∏ Vallons Fleuris d√©couverts",
            "ActeI_OceanSuspendu"    => "üåä Oc√©an suspendu localis√©",
            "ActeI_SanctuaireAncien" => "üèõÔ∏è Sanctuaire ancien trouv√©",
            "ActeI_NidEsquie"        => "‚õ∞Ô∏è Nid d‚ÄôEsquie rep√©r√©",
            "ActeI_Final"            => "üí° Sanctuaire de lumi√®re r√©v√©l√©",
            "ActeII_TerresOubliees"  => "üåë Terres oubli√©es d√©couvertes",
            "ActeII_Manoir"          => "üè∞ Manoir de Renoir localis√©",
            "ActeII_LesAxons"        => "‚ö° Gardiens Axons d√©tect√©s",
            "ActeII_Final"           => "‚ö´ Monolithe r√©v√©l√©",
            _                        => "Site d‚Äôexp√©dition d√©couvert"
        };

        private static string GetLetterText(string questId, string boss) => questId switch
        {
            "ActeI_VallonsFleuris" =>
                "Nos √©claireurs ont rep√©r√© des vallons iridescents o√π r√¥dent les N√©vrons. "
              + "Formez une caravane pour √©liminer " + boss + " et progresser dans l‚Äôexp√©dition.",

            "ActeI_OceanSuspendu" =>
                "Un oc√©an en l√©vitation d√©fie toutes les lois‚Äâ! "
              + boss + " en garde l‚Äôacc√®s. Pr√©parez-vous √† l‚Äôimpossible.",

            "ActeI_SanctuaireAncien" =>
                "Des ruines cyclop√©ennes rec√®lent les secrets du Gommage. "
              + boss + " vous y attend.",

            "ActeI_NidEsquie" =>
                "Fran√ßois r√®gne sur ces falaises. Une erreur et vos colons seront balay√©s.",

            "ActeI_Final" =>
                "Le Ma√Ætre des Lampes concentre la lumi√®re pour barrer votre route ; sa d√©faite "
              + "ouvrira l‚ÄôActe II.",

            "ActeII_TerresOubliees" =>
                "Le Dualiste vous d√©fie dans les Terres oubli√©es. Pr√©parez-vous.",

            "ActeII_Manoir" =>
                "Renoir d√©tient des fragments de v√©rit√© ; affrontez-le dans son manoir hant√©.",

            "ActeII_LesAxons" =>
                "Les Axons prot√®gent l‚Äôacc√®s au Monolithe. √âliminez-les.",

            "ActeII_Final" =>
                "La Peintresse vous attend. L‚Äôultime affrontement approche‚Ä¶",

            _ => $"Un objectif critique a √©t√© localis√©. {boss} est sur place."
        };
    }

    /*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*\
    |  3.  Spawn du boss lorsqu‚Äôon g√©n√®re la map du site         |
    \*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
    public class SitePartWorker_BossSpawn : SitePartWorker
    {
        public override void PostMapGenerate(Map map)
        {
            base.PostMapGenerate(map);

            var site = map.Parent as Site;
            BossSiteExtension ext = site?
                .parts
                .Select(p => p.def.GetModExtension<BossSiteExtension>())
                .FirstOrDefault(e => e != null);

            if (ext != null)
                SpawnBoss(map, ext.bossDefName);
            else
                Log.Warning("[Expedition33] Aucune BossSiteExtension trouv√©e sur le site");
        }


        private static void SpawnBoss(Map map, string bossDefName)
        {
            if (string.IsNullOrEmpty(bossDefName))
            {
                Log.Error("[Expedition33] bossDefName vide : v√©rifiez l‚ÄôIncidentDef !");
                return;
            }

            PawnKindDef kind = DefDatabase<PawnKindDef>.GetNamedSilentFail(bossDefName);
            if (kind == null)
            {
                Log.Error($"[Expedition33] PawnKindDef introuvable : {bossDefName}");
                return;
            }

            Faction bossFaction = Find.FactionManager.FirstFactionOfDef(
                DefDatabase<FactionDef>.GetNamedSilentFail("Expedition33_Nevrons"))
                ?? Faction.OfAncientsHostile;            // fallback s√ªr

            Pawn boss = PawnGenerator.GeneratePawn(new PawnGenerationRequest(
                kind, bossFaction, PawnGenerationContext.NonPlayer, map.Tile));

            if (boss == null)
            {
                Log.Error($"[Expedition33] √âchec de g√©n√©ration du boss ¬´ {bossDefName} ¬ª");
                return;                               // ‚¨ÖÔ∏è stoppe proprement
            }

            IntVec3 spawnPos;
            if (!CellFinder.TryFindRandomSpawnCellForPawnNear(
                    map.Center, map, out spawnPos, 12))
            {
                spawnPos = map.Center;          // position de secours
            }

            ConfigureBossHostileBehavior(boss, map);

            GenSpawn.Spawn(boss, spawnPos, map);
            if (boss.playerSettings != null)
                boss.playerSettings.hostilityResponse = HostilityResponseMode.Attack;

            var lord = LordMaker.MakeNewLord(
                boss.Faction, 
                new LordJob_DefendBossSite(spawnPos, 20f), 
                map, 
                new List<Pawn> { boss });

            // Emp√™che le boss de fuir individuellement (API 1.5)
            boss.mindState.exitMapAfterTick = -1;
            boss.mindState.forcedGotoPosition = IntVec3.Invalid;

            Messages.Message($"‚öîÔ∏è {boss.LabelShort.CapitalizeFirst()} vous attend !",
                            new TargetInfo(spawnPos, map), MessageTypeDefOf.ThreatBig);
        }



        private static void ConfigureBossHostileBehavior(Pawn boss, Map map)
        {
            // Force l'√©tat mental agressif
            if (boss.mindState != null)
            {
                boss.mindState.anyCloseHostilesRecently = true;
                boss.mindState.canFleeIndividual = false; // Le boss ne fuit pas
            }

            // Assure que le boss est en √©tat de combat
            if (boss.jobs != null)
            {
                boss.jobs.EndCurrentJob(JobCondition.InterruptForced, true);
            }

            var gommage = Find.FactionManager.FirstFactionOfDef(
                      DefDatabase<FactionDef>.GetNamed("Expedition33_Nevrons"));

            // ‚úÖ Ne change de faction que si c‚Äôest n√©cessaire
            if (boss.Faction != gommage)
                boss.SetFaction(gommage);

            // Force l'agression contre les colons
            var playerPawns = map.mapPawns.FreeColonists.ToList();
            if (playerPawns.Any())
            {
                foreach (var colonist in playerPawns.Take(3)) // Cible les 3 premiers colons
                {
                    boss.mindState.enemyTarget = colonist;
                    break;
                }
            }
        }

    }

    /*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*\
            |  4.  Surveiller et recr√©er un site perdu (sauvegardes)      |
            \*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
        public static class BossSiteManager
        {
            private static readonly Dictionary<string, int> activeSitesTick = new();

            public static void EnsureBossSite(string questId)
            {
                if (SitePresent(questId) || activeSitesTick.ContainsKey(questId)) return;

                string incidentDefName = GetIncidentForQuest(questId);
                IncidentDef inc = DefDatabase<IncidentDef>.GetNamedSilentFail(incidentDefName);
                if (inc == null) return;

                IncidentParms parms = StorytellerUtility.DefaultParmsNow(IncidentCategoryDefOf.Misc, Find.World);
                parms.faction = Find.FactionManager.FirstFactionOfDef(
                    DefDatabase<FactionDef>.GetNamed("Expedition33_Nevrons"));

                if (inc.Worker.TryExecute(parms))
                {
                    activeSitesTick[questId] = GenTicks.TicksGame;
                    Log.Warning($"[Expedition33] Site recr√©√© pour {questId}");
                }
            }

            /*‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
            private static bool SitePresent(string questId) =>
                Find.WorldObjects.AllWorldObjects.OfType<Site>()
                    .Any(s => s.Label.Contains(GetExpectedSiteLabel(questId)));

            private static string GetIncidentForQuest(string questId) => questId switch
            {
                "ActeI_VallonsFleuris" => "Expedition33_SpawnEvequeSite",
                "ActeI_OceanSuspendu" => "Expedition33_SpawnGobluSite",
                "ActeI_SanctuaireAncien" => "Expedition33_SpawnSakapatateUltimeSite",
                "ActeI_NidEsquie" => "Expedition33_SpawnFrancoisSite",
                "ActeI_Final" => "Expedition33_SpawnMaitreDesLampesSite",
                "ActeII_TerresOubliees" => "Expedition33_SpawnDualisteSite",
                "ActeII_Manoir" => "Expedition33_SpawnRenoirSite",
                "ActeII_LesAxons" => "Expedition33_SpawnSireneSite",
                "ActeII_Final" => "Expedition33_SpawnPeintresseSite",
                _ => null
            };

            private static string GetExpectedSiteLabel(string questId) => questId switch
            {
                "ActeI_VallonsFleuris" => "Vallons Fleuris",
                "ActeI_OceanSuspendu" => "Oc√©an Suspendu",
                "ActeI_SanctuaireAncien" => "Sanctuaire Ancien",
                "ActeI_NidEsquie" => "Nid d'Esquie",
                "ActeI_Final" => "Sanctuaire de Lumi√®re",
                "ActeII_TerresOubliees" => "Terres Oubli√©es",
                "ActeII_Manoir" => "Manoir de Renoir",
                "ActeII_LesAxons" => "Axons",
                "ActeII_Final" => "Monolithe",
                _ => ""
            };
        }
}
